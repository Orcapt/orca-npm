# GitHub Actions Workflow: Build and Push to Target Repository
#
# This workflow builds the project and pushes the build artifacts to another repository.
#
# Required Secrets:
#   - TARGET_REPO_TOKEN: Personal Access Token (PAT) with write access to target repo
#
# Usage:
#   - Automatic: Runs on push to main/master branches
#   - Manual: Use workflow_dispatch to trigger manually

name: Build and Push to Target Repo

on:
    push:
        branches:
            - main
            - master
    workflow_dispatch:

env:
    NODE_VERSION: "18"
    TARGET_REPO: "Orcapt/orca-ui-npm"

jobs:
    build-and-push:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout source repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm install

            - name: Build project
              run: npm run build

            - name: Configure Git
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

            - name: Clone target repository
              run: |
                  git clone https://${{ secrets.TARGET_REPO_TOKEN }}@github.com/${{ env.TARGET_REPO }}.git target-repo
              env:
                  TARGET_REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}

            - name: Copy build artifacts to target repo
              run: |
                  # Copy all .d.ts and .d.ts.map files
                  find . -name '*.d.ts' -not -path './node_modules/*' -not -path './target-repo/*' -exec cp --parents {} target-repo/ \;
                  find . -name '*.d.ts.map' -not -path './node_modules/*' -not -path './target-repo/*' -exec cp --parents {} target-repo/ \;

                  # Copy source files
                  cp -r src target-repo/ || true
                  cp package.json target-repo/ || true
                  cp README.md target-repo/ || true
                  cp LICENSE target-repo/ || true

            - name: Commit and push to target repository
              run: |
                  cd target-repo
                  git add .
                  
                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                  else
                    git commit -m "chore: update build artifacts from ${{ github.repository }}@${{ github.sha }}"
                    git push https://${{ secrets.TARGET_REPO_TOKEN }}@github.com/${{ env.TARGET_REPO }}.git main
                  fi
              env:
                  TARGET_REPO_TOKEN: ${{ secrets.TARGET_REPO_TOKEN }}
